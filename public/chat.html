<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
      name="viewport"
    />
    <title>Calile Hotel Chat</title>
    <meta
      name="description"
      content="An easy way to chat directly with the Calile Hotel"
    />
    <meta name="author" content="The Calile Hotel" />
    <meta property="og:title" content="Calile Hotel Chat" />
    <meta property="og:type" content="website" />
    <meta
      property="og:description"
      content="An easy way to chat directly with the Calile Hotel"
    />
    <meta property="og:image" content="/image.png" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>
  <body>
    <div
      id="chat-container"
      style="
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin-top: -100px;
      "
    ></div>
    <script>
      const postMessage = function (...data) {
        console.debug({ message: data });
        if (window?.ReactNativeWebView?.postMessage) {
          window?.ReactNativeWebView?.postMessage(...data);
        }
        window?.parent?.postMessage(...data);
      };

      function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(
          window
            .atob(base64)
            .split('')
            .map(function (c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join(''),
        );
        return JSON.parse(jsonPayload);
      }

      function chatInitialize(params) {
        console.debug(params);
        const { jwtToken, integrationId, propertyCode, propertyName } = params;
        (async function chatInit() {
          try {
            // check all keys are defined
            for (const key of Object.keys(params))
              if ([undefined, null].includes(params[key]))
                throw Error(`Invalid ${key} (${params})`);
            // prettier-ignore
            !function(o,d,s,e,f){var i,a,p,c=[],h=[];function t(){var t="You must provide a supported major version.";try{if(!f)throw new Error(t);var e,n="https://cdn.smooch.io/",r="smooch";e="string"==typeof this.response?JSON.parse(this.response):this.response;var o=f.match(/([0-9]+)\.?([0-9]+)?\.?([0-9]+)?/),s=o&&o[1],i=o&&o[2],a=o&&o[3],p=e["v"+s],c=e["v"+s+"."+i+".patch"];if(e.url||p||c){var h=d.getElementsByTagName("script")[0],u=d.createElement("script");if(u.async=!0,a)u.src=c||n+r+"."+f+".min.js";else{if(!(5<=s&&p))throw new Error(t);u.src=p}h.parentNode.insertBefore(u,h)}}catch(e){e.message===t&&console.error(e)}}o[s]={init:function(){i=arguments;var t={then:function(e){return h.push({type:"t",next:e}),t},catch:function(e){return h.push({type:"c",next:e}),t}};return t},on:function(){c.push(arguments)},render:function(){a=arguments},destroy:function(){p=arguments}},o.__onWebMessengerHostReady__=function(e){if(delete o.__onWebMessengerHostReady__,o[s]=e,i)for(var t=e.init.apply(e,i),n=0;n<h.length;n++){var r=h[n];t="t"===r.type?t.then(r.next):t.catch(r.next)}a&&e.render.apply(e,a),p&&e.destroy.apply(e,p);for(n=0;n<c.length;n++)e.on.apply(e,c[n])};var n=new XMLHttpRequest;n.addEventListener("load",t),n.open("GET","https://"+e+".webloader.smooch.io/",!0),n.responseType="json",n.send()}(window,document,"Smooch",integrationId,"5");
            const parsedJwtToken = parseJwt(jwtToken);
            if (!parsedJwtToken?.userId)
              throw Error(
                `Invalid userId in jwtToken (${parsedJwtToken?.userId})`,
              );
            const init = Smooch.init({
              integrationId,
              externalId: parsedJwtToken?.userId,
              jwt: jwtToken,
              embedded: true,
              fixedHeader: false,
              integrationOrder: [],
              delegate: {
                beforeSend(message, data) {
                  message.metadata = {
                    property_name: propertyName,
                    short_property_code: propertyCode,
                  };
                  return message;
                },
                onInvalidAuth() {
                  return new Promise((resolve) => resolve(jwtToken));
                },
              },
            }).then(() => {
              postMessage(
                JSON.stringify({
                  event: 'onChatLoaded',
                }),
              );
            });
            Smooch.render(document.getElementById('chat-container'));
            console.debug('Rendered');
            await init;
          } catch (error) {
            console.error(error.name, error.message, error.stack);
            postMessage(
              JSON.stringify({
                event: 'onError',
                params: {
                  error: {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                  },
                },
              }),
            );
          }
        })();
      }
    </script>
  </body>
</html>
